<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EasyPark - Places</title>
    <link rel="stylesheet" href="easypark.css">
</head>
<body>
    <div class="container places-container">
        <h2>POPULAR PLACES NEAR YOU</h2>
        <div class="search-row">
            <input type="search" placeholder="Search places or addresses..." id="placesSearch" />
        </div>

        <div class="places-grid">
            <div class="place-link" data-map="https://www.google.com/maps?q=12.9716,77.5946&z=17&output=embed" data-lat="12.9716" data-lng="77.5946" data-name="AirBNB 1">
            <div class="place-card">
                <div class="place-img"><img src="img/airbnb.jpg" alt="AirBNB"></div>
                <div class="place-info">
                    <div class="place-name">AirBNB 1</div>
                    <div class="place-traffic traffic-low">Traffic: Low</div>
                </div>
            </div>
            </div>

            <div class="place-link" data-map="https://www.google.com/maps?q=28.7041,77.1025&z=17&output=embed" data-lat="28.7041" data-lng="77.1025" data-name="AirBNB 2">
            <div class="place-card">
                <div class="place-img"><img src="img/airbnb.jpg" alt="AirBNB"></div>
                <div class="place-info">
                    <div class="place-name">AirBNB 2</div>
                    <div class="place-traffic traffic-medium">Traffic: Medium</div>
                </div>
            </div>
            </div>

            <div class="place-card">
                <div class="place-img"><img src="img/airbnb.jpg" alt="AirBNB"></div>
                <div class="place-info">
                    <div class="place-name">AirBNB 3</div>
                    <div class="place-traffic traffic-high">Traffic: High</div>
                </div>
            </div>
            
            <div class="place-card">
                <div class="place-img"><img src="img/airbnb.jpg" alt="AirBNB"></div>
                <div class="place-info">
                    <div class="place-name">AirBNB 4</div>
                    <div class="place-traffic traffic-low">Traffic: Low</div>
                </div>
            </div>

            <div class="place-card">
                <div class="place-img"><img src="img/airbnb.jpg" alt="AirBNB"></div>
                <div class="place-info">
                    <div class="place-name">AirBNB 5</div>
                    <div class="place-traffic traffic-medium">Traffic: Medium</div>
                </div>
            </div>

            <div class="place-card">
                <div class="place-img"><img src="img/airbnb.jpg" alt="AirBNB"></div>
                <div class="place-info">
                    <div class="place-name">AirBNB 6</div>
                    <div class="place-traffic traffic-high">Traffic: High</div>
                </div>
            </div>
        </div>

    </div>

    <div id="mapModal" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;">
      <div style="background:#fff;border-radius:12px;max-width:90vw;max-height:80vh;overflow:hidden;position:relative;box-shadow:0 8px 32px rgba(0,0,0,0.3);">
        <button id="closeMapModal" style="position:absolute;top:8px;right:8px;background:#283593;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:1.3rem;cursor:pointer;">&times;</button>
        <iframe id="mapFrame" src="" width="400" height="350" style="border:0;display:block;max-width:90vw;max-height:70vh;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </div>
    <!-- Action sheet for place actions -->
    <div id="placeActionSheet" style="display:none;position:fixed;z-index:10001;left:0;bottom:0;width:100vw;background:rgba(255,255,255,0.98);box-shadow:0 -8px 24px rgba(0,0,0,0.15);padding:12px;border-top-left-radius:12px;border-top-right-radius:12px;">
        <div style="max-width:760px;margin:0 auto;">
            <div id="actionTitle" style="font-weight:700;margin-bottom:8px">Place</div>
            <div style="display:flex;gap:8px;flex-direction:column;">
                <button id="openMapsBtn" style="padding:12px;border-radius:8px;border:none;background:#1976d2;color:#fff;cursor:pointer">Open in Google Maps (directions)</button>
                <button id="inPageNavBtn" style="padding:12px;border-radius:8px;border:1px solid #ddd;background:#fff;color:#222;cursor:pointer">In-page navigation</button>
                <button id="closeActionSheet" style="padding:10px;border-radius:8px;border:none;background:#eee;color:#222;cursor:pointer">Cancel</button>
            </div>
        </div>
    </div>
        <!-- In-page navigation overlay -->
        <div id="navOverlay" style="display:none;position:fixed;z-index:10000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
            <div style="background:#fff;border-radius:12px;padding:16px;max-width:420px;width:92%;box-shadow:0 8px 32px rgba(0,0,0,0.3);position:relative;">
                <button id="closeNavOverlay" style="position:absolute;top:8px;right:8px;background:#283593;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:1.2rem;cursor:pointer;">&times;</button>
                <h3 id="navTitle">Navigation</h3>
                <p id="navStatus">Prepare to navigate</p>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <button id="startNavBtn" style="flex:1;padding:10px;border-radius:8px;border:none;background:#1976d2;color:#fff;cursor:pointer;">Start navigation</button>
                    <button id="stopNavBtn" style="flex:1;padding:10px;border-radius:8px;border:none;background:#e0e0e0;color:#222;cursor:pointer;display:none;">Stop</button>
                </div>
                <p style="margin-top:12px;font-size:0.95rem;">Distance to destination: <span id="navDistance">â€”</span> meters</p>
            </div>
        </div>
    <script>
        // Search/filter functionality for places
        (function(){
            const searchInput = document.getElementById('placesSearch');
            const cards = Array.from(document.querySelectorAll('.place-card'));

            function normalize(s){
                return (s||'').trim().toLowerCase();
            }

            function filterCards(){
                const q = normalize(searchInput.value);
                if(!q){
                    // empty -> show all
                    cards.forEach(c => c.style.display = 'flex');
                    return;
                }

                // If the user types an exact full name (like "airbnb 1"), only match exact names.
                // We'll treat queries that include a number at the end as exact-name intent.
                const exactNamePattern = /\d+$/;
                const isExactName = exactNamePattern.test(q);

                cards.forEach(card => {
                    const nameEl = card.querySelector('.place-name');
                    const name = normalize(nameEl && nameEl.textContent);

                    let show = false;
                    if(isExactName){
                        show = name === q; // exact match
                    } else {
                        // partial match anywhere in the name
                        show = name.indexOf(q) !== -1;
                    }

                    card.style.display = show ? 'flex' : 'none';
                });
            }

            searchInput.addEventListener('input', filterCards);
            // allow searching when pressing Enter too
            searchInput.addEventListener('keyup', function(e){ if(e.key === 'Enter') filterCards(); });
        })();

                        // Modal map popup for AirBNB 1 and 2 (kept for embed view)
                        document.querySelectorAll('.place-link[data-map]').forEach(function(link){
                            link.addEventListener('dblclick', function(e){
                                e.preventDefault();
                                var mapUrl = link.getAttribute('data-map');
                                var modal = document.getElementById('mapModal');
                                var frame = document.getElementById('mapFrame');
                                frame.src = mapUrl;
                                modal.style.display = 'flex';
                            });
                        });
        document.getElementById('closeMapModal').onclick = function(){
          document.getElementById('mapModal').style.display = 'none';
          document.getElementById('mapFrame').src = '';
        };
        // Optional: close modal on background click
        document.getElementById('mapModal').addEventListener('click', function(e){
          if(e.target === this){
            this.style.display = 'none';
            document.getElementById('mapFrame').src = '';
          }
        });

                // In-site navigation flow
                (function(){
                    var currentWatchId = null;
                    var destLat = null, destLng = null, destName = '';
                    var reachThreshold = 15; // meters

                    function toMeters(distance){ return Math.round(distance); }

                    function haversine(lat1, lon1, lat2, lon2){
                        function toRad(x){ return x * Math.PI / 180; }
                        var R = 6371000; // meters
                        var dLat = toRad(lat2-lat1);
                        var dLon = toRad(lon2-lon1);
                        var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
                        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                        return R * c;
                    }

                    // Use an action sheet when clicking place links with coordinates
                    var sheet = document.getElementById('placeActionSheet');
                    var actionTitle = document.getElementById('actionTitle');
                    var openMapsBtn = document.getElementById('openMapsBtn');
                    var inPageNavBtn = document.getElementById('inPageNavBtn');
                    var closeActionSheet = document.getElementById('closeActionSheet');

                    document.querySelectorAll('.place-link[data-lat][data-lng]').forEach(function(el){
                        el.addEventListener('click', function(e){
                            e.preventDefault();
                            destLat = parseFloat(el.dataset.lat);
                            destLng = parseFloat(el.dataset.lng);
                            destName = el.dataset.name || 'Destination';
                            actionTitle.textContent = 'Actions for ' + destName;
                            sheet.style.display = 'block';
                        });
                    });

                    closeActionSheet.onclick = function(){ sheet.style.display = 'none'; };

                    openMapsBtn.onclick = function(){
                        sheet.style.display = 'none';
                        if(!navigator.geolocation){ alert('Geolocation required to open directions.'); return; }
                        document.getElementById('navStatus').textContent = 'Resolving current location...';
                        navigator.geolocation.getCurrentPosition(function(pos){
                            var olat = pos.coords.latitude, olng = pos.coords.longitude;
                            // Google Maps directions URL: /maps/dir/?api=1&origin=lat,lng&destination=lat,lng
                            var url = 'https://www.google.com/maps/dir/?api=1&origin='+olat+','+olng+'&destination='+destLat+','+destLng+'&travelmode=driving';
                            window.open(url, '_blank');
                        }, function(err){
                            alert('Unable to get current location: ' + (err && err.message));
                        }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
                    };

                    inPageNavBtn.onclick = function(){
                        sheet.style.display = 'none';
                        // prefill nav overlay and open it, then auto-start
                        document.getElementById('navTitle').textContent = 'Navigate to ' + destName;
                        document.getElementById('navStatus').textContent = 'Ready to start navigation';
                        document.getElementById('navDistance').textContent = 'â€”';
                        document.getElementById('startNavBtn').style.display = 'none';
                        document.getElementById('stopNavBtn').style.display = 'inline-block';
                        document.getElementById('navOverlay').style.display = 'flex';
                        // Start geolocation watch immediately
                        if(navigator.geolocation){
                            if(currentWatchId !== null && navigator.geolocation){ navigator.geolocation.clearWatch(currentWatchId); }
                            currentWatchId = navigator.geolocation.watchPosition(function(pos){
                                var lat = pos.coords.latitude, lng = pos.coords.longitude;
                                var dist = haversine(lat,lng,destLat,destLng);
                                document.getElementById('navDistance').textContent = toMeters(dist);
                                document.getElementById('navStatus').textContent = 'Navigating â€” GPS active';
                                if(dist <= reachThreshold){
                                    if(currentWatchId !== null && navigator.geolocation){ navigator.geolocation.clearWatch(currentWatchId); }
                                    currentWatchId = null;
                                    // arrived -> goto parking.html
                                    window.location.href = 'parking.html?dest='+encodeURIComponent(destName)+'&lat='+destLat+'&lng='+destLng;
                                }
                            }, function(err){
                                document.getElementById('navStatus').textContent = 'GPS error: ' + (err.message||err.code);
                            }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
                        } else {
                            document.getElementById('navStatus').textContent = 'Geolocation not supported';
                        }
                    };

                    document.getElementById('closeNavOverlay').onclick = function(){
                        stopNav();
                        document.getElementById('navOverlay').style.display = 'none';
                    };

                    document.getElementById('startNavBtn').onclick = function(){
                        if(!destLat || !destLng) return;
                        this.style.display = 'none';
                        document.getElementById('stopNavBtn').style.display = 'inline-block';
                        document.getElementById('navStatus').textContent = 'Starting GPS...';
                        if(navigator.geolocation){
                            currentWatchId = navigator.geolocation.watchPosition(function(pos){
                                var lat = pos.coords.latitude, lng = pos.coords.longitude;
                                var dist = haversine(lat,lng,destLat,destLng);
                                document.getElementById('navDistance').textContent = toMeters(dist);
                                document.getElementById('navStatus').textContent = 'Navigating â€” GPS active';
                                if(dist <= reachThreshold){
                                    stopNav();
                                    // arrived -> goto parking.html
                                    window.location.href = 'parking.html?dest='+encodeURIComponent(destName)+'&lat='+destLat+'&lng='+destLng;
                                }
                            }, function(err){
                                document.getElementById('navStatus').textContent = 'GPS error: ' + (err.message||err.code);
                            }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
                        } else {
                            document.getElementById('navStatus').textContent = 'Geolocation not supported';
                        }
                    };

                    document.getElementById('stopNavBtn').onclick = function(){ stopNav(); };

                    function stopNav(){
                        if(currentWatchId !== null && navigator.geolocation){ navigator.geolocation.clearWatch(currentWatchId); }
                        currentWatchId = null;
                        document.getElementById('startNavBtn').style.display = 'inline-block';
                        document.getElementById('stopNavBtn').style.display = 'none';
                        document.getElementById('navStatus').textContent = 'Navigation stopped';
                    }
                })();
    </script>
</body>
</html>